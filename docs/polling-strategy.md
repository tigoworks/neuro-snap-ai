# 轮询策略优化文档

## 概述

基于用户提供的时间表，我们优化了前端SDK中的分析结果轮询策略，实现了更智能的指数退避机制。

## 轮询时间表

| 尝试次数 | 间隔时间 | 累计时间 |
|---------|---------|---------|
| 1-5     | 10-12秒  | 0-1分钟  |
| 6-10    | 12.5-14.5秒 | 1-2分钟 |
| 11-15   | 15-17秒  | 2-3.1分钟 |
| 16-20   | 17.5-19.5秒 | 3.4-4.9分钟 |

## 策略特点

### 1. 智能间隔调整
- **阶段性增长**：根据尝试次数分为4个阶段，每个阶段有不同的等待间隔
- **渐进式增长**：间隔时间逐步增加，避免过度频繁的请求
- **合理上限**：最大间隔控制在19.5秒，避免用户等待过久

### 2. 随机化机制
- **避免峰值**：每个间隔范围内使用随机时间，避免多个客户端同时请求
- **负载均衡**：减少服务器在特定时间点的负载压力

### 3. 详细进度反馈
- **实时进度**：显示当前尝试次数和总次数
- **累计时间**：实时显示总等待时间
- **已用时间**：显示从开始轮询到当前的实际用时

### 4. 错误处理优化
- **网络错误**：使用相同的间隔策略处理网络连接问题
- **速率限制**：特殊处理429状态码，使用服务器建议的重试时间
- **状态识别**：区分404（分析中）和其他错误状态

## 实现代码

```javascript
// 计算等待间隔的函数
const getWaitInterval = (attempt) => {
  if (attempt <= 5) {
    // 1-5次: 10-12秒
    return 10000 + Math.random() * 2000;
  } else if (attempt <= 10) {
    // 6-10次: 12.5-14.5秒
    return 12500 + Math.random() * 2000;
  } else if (attempt <= 15) {
    // 11-15次: 15-17秒
    return 15000 + Math.random() * 2000;
  } else {
    // 16-20次: 17.5-19.5秒
    return 17500 + Math.random() * 2000;
  }
};
```

## 使用示例

```javascript
const api = new NeuroSnapAPI('http://localhost:8080/api', 'your-api-key');

// 使用优化的轮询策略
const result = await api.pollAnalysisResult(surveyId, {
  maxAttempts: 20,
  onProgress: (current, total) => {
    console.log(`进度: ${current}/${total}`);
  }
});
```

## 性能优势

### 1. 用户体验
- **清晰反馈**：用户可以看到详细的进度和时间信息
- **合理等待**：避免过短或过长的等待间隔
- **预期管理**：用户可以预估大概的等待时间

### 2. 服务器友好
- **负载分散**：随机化间隔避免请求峰值
- **资源节约**：合理的重试间隔减少不必要的请求
- **错误恢复**：智能处理各种错误情况

### 3. 可靠性
- **容错能力**：处理网络波动和临时错误
- **状态追踪**：准确识别分析进度状态
- **超时保护**：避免无限等待

## 配置参数

| 参数 | 默认值 | 说明 |
|-----|-------|------|
| maxAttempts | 20 | 最大尝试次数 |
| onProgress | () => {} | 进度回调函数 |

## 日志输出示例

```
🔄 开始轮询分析结果: {
  surveyId: 'xxx-xxx-xxx',
  maxAttempts: 20,
  strategy: '优化指数退避策略'
}
📈 进度: 1/20 (已用时: 0秒)
⏳ 分析进行中 (404)，11秒后重试... (1/20) [累计: 0.2分钟]
📈 进度: 2/20 (已用时: 11秒)
⏳ 分析进行中 (404)，12秒后重试... (2/20) [累计: 0.4分钟]
...
✅ 分析完成！总等待时间: 2.3分钟
```

## 总结

新的轮询策略在保证用户体验的同时，有效减少了服务器负载，提高了系统的整体性能和可靠性。通过阶段性的间隔调整和随机化机制，实现了更智能的等待策略。 